FROM node:22-alpine AS base

WORKDIR /app

# Instalar dependencias del sistema
RUN apk add --no-cache git openssh

# Copiar scripts helper al contenedor
COPY apps/<%=projectName%>/copy_if_exists.sh /usr/local/bin/
COPY apps/<%=projectName%>/copy-files.sh /usr/local/bin/
RUN chmod +x /usr/local/bin/copy_if_exists.sh /usr/local/bin/copy-files.sh

# Stage for installing dependencies and building
FROM base AS builder

# Copiar package.json y package-lock.json para la caché de Docker
COPY package.json package-lock.json ./

# Preparar directorios para los package.json de apps y libs
RUN mkdir -p ./apps/<%=projectName%>/<%=webAppName%> \
    ./libs/<%=projectName%>/shared \
    ./libs/<%=projectName%>/api-interfaces

# Copiar package.json de la aplicación - este archivo debe existir
COPY apps/<%=projectName%>/<%=webAppName%>/package.json ./apps/<%=projectName%>/<%=webAppName%>/

# Copiar package.json de las libs usando copy_if_exists
RUN /usr/local/bin/copy_if_exists.sh libs/<%=projectName%>/shared/package.json ./libs/<%=projectName%>/shared/
RUN /usr/local/bin/copy_if_exists.sh libs/<%=projectName%>/api-interfaces/package.json ./libs/<%=projectName%>/api-interfaces/

# Eliminar haiku-generator de las dependencias
RUN node -e "const fs=require('fs'); \
    const pkg=JSON.parse(fs.readFileSync('./package.json')); \
    if(pkg.dependencies && pkg.dependencies['haiku-generator']) delete pkg.dependencies['haiku-generator']; \
    if(pkg.devDependencies && pkg.devDependencies['haiku-generator']) delete pkg.devDependencies['haiku-generator']; \
    fs.writeFileSync('./package.json', JSON.stringify(pkg, null, 2));"

# Instalar dependencias
RUN npm install

# Copiar archivos de configuración TypeScript - estos archivos deben existir
COPY tsconfig.base.json ./
COPY apps/<%=projectName%>/tsconfig.json ./apps/<%=projectName%>/

# Copiar el código fuente de la aplicación - debe existir
COPY apps/<%=projectName%>/<%=webAppName%> ./apps/<%=projectName%>/<%=webAppName%>/

# Copiar libs compartidas usando copy-files para evitar problemas de recursión
RUN /usr/local/bin/copy-files.sh "libs/<%=projectName%>/shared/*" "./libs/<%=projectName%>/shared/"
RUN /usr/local/bin/copy-files.sh "libs/<%=projectName%>/api-interfaces/*" "./libs/<%=projectName%>/api-interfaces/"

# Construir la aplicación
WORKDIR /app/apps/<%=projectName%>/<%=webAppName%>
RUN npx vite build --outDir /app/dist

# Producción - imagen nginx
FROM nginx:alpine

WORKDIR /usr/share/nginx/html

# Copiar la aplicación construida
COPY --from=builder /app/dist .

# Copiar configuración de nginx
COPY apps/<%=projectName%>/<%=webAppName%>/nginx.conf /etc/nginx/conf.d/default.conf.template

# Instalar herramientas necesarias
RUN apk add --no-cache gettext

# Exponer puerto
EXPOSE 80

# Iniciar nginx con sustitución de variables
CMD ["/bin/sh", "-c", "envsubst '$$SERVER_PORT' < /etc/nginx/conf.d/default.conf.template > /etc/nginx/conf.d/default.conf && nginx -g 'daemon off;'"]
