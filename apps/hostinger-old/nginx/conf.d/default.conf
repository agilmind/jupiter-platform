# tools/vps/src/blueprints/nginx/conf.d/default.conf.template






# Bloque HTTP (Redirige TODO a HTTPS y maneja ACME)
server {
    listen 80 default_server;
    listen [::]:80 default_server;
    server_name jupiter.ar webapp.jupiter.ar www.jupiter.ar grafana.jupiter.ar _;

    location /.well-known/acme-challenge/ {
        alias /var/www/letsencrypt/challenges-in-container/;
    }
    location / {
        return 301 https://$host$request_uri;
    }
}

# Bloque HTTPS para DOMINIOS PRINCIPALES
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name jupiter.ar webapp.jupiter.ar www.jupiter.ar; # SOLO los principales

    # Certificados y opciones SSL
    ssl_certificate "/etc/letsencrypt/live/jupiter.ar/fullchain.pem";
    ssl_certificate_key "/etc/letsencrypt/live/jupiter.ar/privkey.pem";
    include /etc/nginx/includes/options-ssl-nginx.conf;
    ssl_dhparam /etc/nginx/includes/ssl-dhparams.pem;

    # Configuración para servir contenido estático o hacer proxy a una app principal
    root /usr/share/nginx/html; # O la raíz de tu app principal
    index index.html index.htm;
    location / {
        try_files $uri $uri/ =404; # Servir archivos estáticos
        # O si aquí hubiera una app Node en otro contenedor (ej. 'webapp'):
        # proxy_pass http://webapp:4000;
        # include /etc/nginx/includes/proxy_params; # Suponiendo un archivo con proxy_set_header comunes
    }

    # Ejemplo de proxy para una API
    # location /api/ {
    #    proxy_pass http://api_backend:5000;
    #    include /etc/nginx/includes/proxy_params;
    # }

    # Cabeceras de seguridad para estos dominios
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;

} # <-- Fin del server block para dominios principales

# Bloque HTTPS para GRAFANA (Condicional)

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name grafana.jupiter.ar; # SOLO el de Grafana

    # Certificados y opciones SSL (los mismos)
    ssl_certificate "/etc/letsencrypt/live/jupiter.ar/fullchain.pem";
    ssl_certificate_key "/etc/letsencrypt/live/jupiter.ar/privkey.pem";
    include /etc/nginx/includes/options-ssl-nginx.conf;
    ssl_dhparam /etc/nginx/includes/ssl-dhparams.pem;

    # Proxy inverso a Grafana
    location / {
        proxy_pass http://grafana:3000;
        proxy_set_header Host $host;
        # ... otros headers de proxy para Grafana ...
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
    }
}
 # <-- Fin del server block para Grafana (Condicional)
